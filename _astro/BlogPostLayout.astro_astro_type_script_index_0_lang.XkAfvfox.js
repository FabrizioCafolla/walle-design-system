class u{tocItems=[];currentActiveIndex=-1;articleContent=null;tocNav=null;tocContainer=null;constructor(){this.articleContent=document.getElementById("article-content"),this.tocNav=document.getElementById("toc-nav"),this.tocContainer=document.getElementById("toc")}init(){this.generateTOC(),this.initSmoothScroll(),this.updateProgress(),this.updateActiveTOC(),this.bindEvents()}generateTOC(){if(!this.articleContent||!this.tocNav||!this.tocContainer)return;const n=this.articleContent.querySelectorAll("h2");if(n.length===0){this.tocContainer.style.display="none";return}this.tocNav.classList.add("loading"),this.tocItems=[];const e=document.createDocumentFragment();n.forEach((t,o)=>{const s=t;let i=s.id;i||(i=this.generateHeadingId(s,o),s.id=i);const a={id:i,text:s.textContent||"",element:s};this.tocItems.push(a),e.appendChild(this.createTocLink(a,o))}),this.tocNav.appendChild(e),this.tocNav.classList.remove("loading"),this.addMobileCollapse()}generateHeadingId(n,e){const t=n.textContent||"";return`heading-h2-${e}-${t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s-]/g,"").replace(/\s+/g,"-").substring(0,50)}`}createTocLink(n,e){const t=document.createElement("a");return t.href=`#${n.id}`,t.textContent=n.text,t.setAttribute("data-toc-index",e.toString()),t.setAttribute("data-level","2"),t.setAttribute("aria-label",`Go to: ${n.text}`),t}addMobileCollapse(){if(!this.tocContainer)return;const n=this.tocContainer.querySelector("h3");if(!n)return;const e=n.cloneNode(!0);if(n.parentNode?.replaceChild(e,n),window.innerWidth<=1024){let t=0,o=0;const s=r=>{r.preventDefault(),this.tocContainer?.classList.toggle("collapsed"),"vibrate"in navigator&&navigator.vibrate(50)},i=r=>{t=r.touches[0].clientY},a=r=>{o=r.changedTouches[0].clientY,Math.abs(o-t)<10&&s(r)};e.addEventListener("touchstart",i,{passive:!0}),e.addEventListener("touchend",a,{passive:!1}),e.addEventListener("click",s),(this.tocItems.length>5||window.innerWidth<=768)&&this.tocContainer.classList.add("collapsed"),e.style.cursor="pointer",e.setAttribute("role","button"),e.setAttribute("aria-expanded","true"),e.setAttribute("aria-label","Toggle table of contents");const l=new MutationObserver(r=>{r.forEach(d=>{if(d.type==="attributes"&&d.attributeName==="class"){const h=this.tocContainer?.classList.contains("collapsed");e.setAttribute("aria-expanded",(!h).toString())}})});this.tocContainer&&l.observe(this.tocContainer,{attributes:!0})}}updateActiveTOC(){if(this.tocItems.length===0)return;const n=window.pageYOffset,e=150;let t=-1;for(let o=0;o<this.tocItems.length;o++)this.tocItems[o].element.getBoundingClientRect().top+n<=n+e&&(t=o);t!==this.currentActiveIndex&&(this.updateActiveLinks(t),this.currentActiveIndex=t)}updateActiveLinks(n){document.querySelectorAll(".toc-nav a").forEach((t,o)=>{t.classList.toggle("active",o===n)})}updateProgress(){const n=document.querySelector(".article-content"),e=document.getElementById("progress-bar"),t=document.getElementById("toc-progress");if(!n)return;const o=n.scrollHeight,s=n.offsetTop,i=window.innerHeight,a=window.pageYOffset,l=Math.min(Math.max((a-s+i*.25)/o,0),1),r=Math.round(l*100);e&&(e.style.width=`${r}%`),t&&(t.style.width=`${r}%`,t.setAttribute("aria-label",`Reading progress: ${r}%`))}initSmoothScroll(){document.addEventListener("click",n=>{const e=n.target;if(e.tagName==="A"&&e.getAttribute("href")?.startsWith("#")){n.preventDefault();const t=e.getAttribute("href")?.substring(1),o=document.getElementById(t||"");o&&this.scrollToElement(o)}})}scrollToElement(n){const e=n.getBoundingClientRect(),t=window.pageYOffset||document.documentElement.scrollTop,o=e.top+t,s=window.innerWidth<=768,i=s?80:120;s&&this.tocContainer&&this.tocContainer.classList.add("collapsed"),"scrollBehavior"in document.documentElement.style?window.scrollTo({top:o-i,behavior:"smooth"}):this.smoothScrollPolyfill(o-i,500)}smoothScrollPolyfill(n,e){const t=window.pageYOffset,o=n-t,s=performance.now(),i=a=>{const l=a-s,r=Math.min(l/e,1),h=(c=>c<.5?4*c*c*c:(c-1)*(2*c-2)*(2*c-2)+1)(r);window.scrollTo(0,t+o*h),r<1&&requestAnimationFrame(i)};requestAnimationFrame(i)}throttle(n,e){let t;return function(...o){t||(n.apply(this,o),t=!0,setTimeout(()=>t=!1,e))}}bindEvents(){const n=this.throttle(()=>{this.updateProgress(),this.updateActiveTOC()},16),e=this.throttle(()=>{this.updateProgress(),this.addMobileCollapse()},250);window.addEventListener("scroll",n,{passive:!0}),window.addEventListener("resize",e,{passive:!0}),window.addEventListener("orientationchange",()=>{setTimeout(()=>{this.updateProgress(),this.addMobileCollapse()},100)});let t=0;document.addEventListener("touchend",o=>{const s=new Date().getTime();s-t<=300&&o.target.closest(".toc-nav a")&&o.preventDefault(),t=s},!1),document.addEventListener("keydown",o=>{o.key==="Escape"&&window.innerWidth<=1024&&this.tocContainer?.classList.add("collapsed")})}}document.addEventListener("DOMContentLoaded",()=>{new u().init()});
