class v{tocItems=[];currentActiveIndex=-1;articleContent=null;tocNav=null;tocContainer=null;isScrolling=!1;isMobile=!1;lastScrollTimestamp=0;options;constructor(t={}){this.articleContent=document.getElementById("article-content"),this.tocNav=document.getElementById("toc-nav"),this.tocContainer=document.getElementById("toc"),this.options={headingSelector:"h2, h3",skipAttribute:"data-toc-skip",skipClass:"toc-skip",skipContainerAttribute:"data-toc-skip-container",excludeSelectors:[],excludeTextPatterns:[],...t},this.updateDeviceType()}init(){this.generateTOC(),this.initNavigationHandlers(),this.updateActiveTOC(),this.bindEvents()}updateDeviceType(){this.isMobile=window.innerWidth<=1024}generateTOC(){if(!this.articleContent||!this.tocNav||!this.tocContainer)return;const t=this.articleContent.querySelectorAll(this.options.headingSelector||"h2, h3");if(t.length===0){this.tocContainer.style.display="none";return}this.tocNav.classList.add("loading"),this.tocItems=[];const e=document.createDocumentFragment();t.forEach((n,i)=>{const o=n;if(this.shouldExcludeHeading(o))return;let c=o.id;c||(c=this.generateHeadingId(o,i),o.id=c);const a={id:c,text:o.textContent||"",element:o};this.tocItems.push(a),e.appendChild(this.createTocLink(a,this.tocItems.length-1,o.tagName))}),this.tocNav.appendChild(e),this.tocNav.classList.remove("loading"),this.setupMobileInteraction()}shouldExcludeHeading(t){const{skipAttribute:e,skipClass:n,skipContainerAttribute:i,excludeSelectors:o=[],excludeTextPatterns:c=[]}=this.options;if(e&&t.hasAttribute(e)||n&&t.classList.contains(n)||i&&t.closest(`[${i}]`)||o.some(r=>t.matches(r)))return!0;const a=(t.textContent||"").trim();return!!c.some(r=>r.test(a))}generateHeadingId(t,e){const n=t.textContent||"";return`${t.tagName.toLowerCase()}-${e}-${n.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s-]/g,"").replace(/\s+/g,"-").substring(0,50)}`}createTocLink(t,e,n){const i=document.createElement("a");return i.href=`#${t.id}`,i.textContent=t.text,i.setAttribute("data-toc-index",e.toString()),i.setAttribute("data-level",n==="H2"?"2":"3"),i.setAttribute("aria-label",`Navigate to: ${t.text}`),i.setAttribute("role","link"),n==="H3"&&(i.style.paddingLeft="2.5rem",i.style.fontSize="0.85rem"),i}setupMobileInteraction(){if(!this.tocContainer)return;const t=this.tocContainer.querySelector("h3");if(!t)return;const e=t.cloneNode(!0);t.parentNode?.replaceChild(e,t),this.isMobile&&(this.setupHeaderToggle(e),(this.tocItems.length>6||window.innerWidth<=768)&&this.tocContainer.classList.add("collapsed"))}setupHeaderToggle(t){let e=0,n=0,i=!0;const o=()=>{if(!this.tocContainer)return;const s=this.tocContainer.classList.contains("collapsed");this.tocContainer.classList.toggle("collapsed"),t.setAttribute("aria-expanded",s.toString()),"vibrate"in navigator&&navigator.vibrate(30);const d=s?"Table of contents expanded":"Table of contents collapsed";this.announceToScreenReader(d)},c=s=>{e=s.touches[0].clientY,n=s.touches[0].clientX,i=!0},a=s=>{const d=Math.abs(s.touches[0].clientY-e),f=Math.abs(s.touches[0].clientX-n);(d>10||f>10)&&(i=!1)},r=s=>{i&&(s.preventDefault(),o())};t.addEventListener("touchstart",c,{passive:!0}),t.addEventListener("touchmove",a,{passive:!0}),t.addEventListener("touchend",r,{passive:!1}),t.addEventListener("click",s=>{this.isMobile&&(s.preventDefault(),o())}),t.style.cursor="pointer",t.setAttribute("role","button"),t.setAttribute("tabindex","0"),t.setAttribute("aria-expanded","true"),t.setAttribute("aria-controls","toc-nav"),t.setAttribute("aria-label","Toggle table of contents"),t.addEventListener("keydown",s=>{(s.key==="Enter"||s.key===" ")&&(s.preventDefault(),o())});const l=new MutationObserver(s=>{s.forEach(d=>{if(d.type==="attributes"&&d.attributeName==="class"){const f=this.tocContainer?.classList.contains("collapsed");t.setAttribute("aria-expanded",(!f).toString())}})});this.tocContainer&&l.observe(this.tocContainer,{attributes:!0})}initNavigationHandlers(){this.tocNav&&this.tocNav.addEventListener("click",t=>{const e=t.target;if(e.tagName==="A"&&e.getAttribute("href")?.startsWith("#")){t.preventDefault(),t.stopPropagation();const n=e.getAttribute("href")?.substring(1),i=document.getElementById(n||"");i&&(e.classList.add("navigating"),this.isMobile&&this.tocContainer?(this.tocContainer.classList.add("collapsed"),setTimeout(()=>{this.scrollToElement(i,e)},150)):this.scrollToElement(i,e))}},{passive:!1})}scrollToElement(t,e){const n=Date.now();if(this.isScrolling&&n-this.lastScrollTimestamp>3e3&&(this.isScrolling=!1),this.isScrolling)return;this.isScrolling=!0,this.lastScrollTimestamp=n,setTimeout(()=>{this.isScrolling&&(this.isScrolling=!1)},3e3);const i=this.getDynamicOffset();if(this.isMobile){t.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{window.scrollBy(0,-i),this.onScrollComplete(e)},320);return}const o=t.getBoundingClientRect(),c=window.pageYOffset||document.documentElement.scrollTop,r=o.top+c-i;if(e.classList.add("navigating"),"scrollBehavior"in document.documentElement.style)if(window.scrollTo({top:r,behavior:"smooth"}),setTimeout(()=>{const l=window.scrollY;Math.abs(l-r)<4&&(window.scrollTo({top:r,behavior:"auto"}),this.onScrollComplete(e))},240),"onscrollend"in window){const l=()=>{window.removeEventListener("scrollend",l),this.onScrollComplete(e)};window.addEventListener("scrollend",l,{once:!0})}else this.waitForScrollEnd(()=>{this.onScrollComplete(e)});else window.scrollTo(0,r),this.onScrollComplete(e)}waitForScrollEnd(t){let e=window.pageYOffset,n=0;const i=50,o=()=>{const c=window.pageYOffset;n++,Math.abs(c-e)<1?t():n<i?(e=c,setTimeout(o,50)):t()};setTimeout(o,50)}onScrollComplete(t){this.isScrolling=!1,t.classList.remove("navigating"),this.isMobile&&this.announceToScreenReader("Navigated to section");const e=t.getAttribute("href")?.substring(1);if(e){const n=this.tocItems.findIndex(i=>i.id===e);n!==-1&&n!==this.currentActiveIndex&&(this.updateActiveLinks(n),this.currentActiveIndex=n)}}getDynamicOffset(){if(!this.isMobile)return 120;const t=this.tocItems[0]?.element;if(t){const e=parseInt(getComputedStyle(t).scrollMarginTop||"0",10);if(!isNaN(e)&&e>0)return e}return 100}updateActiveTOC(){if(this.tocItems.length===0||this.isScrolling)return;const t=window.pageYOffset,e=this.getDynamicOffset();let n=-1;for(let i=0;i<this.tocItems.length;i++)this.tocItems[i].element.getBoundingClientRect().top+t<=t+e&&(n=i);n!==this.currentActiveIndex&&(this.updateActiveLinks(n),this.currentActiveIndex=n)}updateActiveLinks(t){const e=this.tocNav?.querySelectorAll("a");if(e&&(e.forEach((n,i)=>{const o=i===t;n.classList.toggle("active",o),n.setAttribute("aria-current",o?"location":"false")}),t>=0&&e[t]&&this.tocNav)){const n=e[t],i=this.tocNav.getBoundingClientRect(),o=n.getBoundingClientRect();(o.top<i.top||o.bottom>i.bottom)&&n.scrollIntoView({block:"nearest",behavior:"smooth"})}}throttle(t,e){let n;return function(...i){n||(t.apply(this,i),n=!0,setTimeout(()=>n=!1,e))}}debounce(t,e){let n=null;return function(...i){n!==null&&clearTimeout(n),n=window.setTimeout(()=>t.apply(this,i),e)}}announceToScreenReader(t){const e=document.createElement("div");e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","true"),e.className="sr-only",e.textContent=t,document.body.appendChild(e),setTimeout(()=>{document.body.removeChild(e)},1e3)}bindEvents(){const t=this.throttle(()=>{this.updateActiveTOC()},16),e=this.debounce(()=>{this.updateDeviceType(),this.setupMobileInteraction()},250);window.addEventListener("scroll",t,{passive:!0}),window.addEventListener("resize",e,{passive:!0}),window.addEventListener("orientationchange",()=>{setTimeout(()=>{this.updateDeviceType(),this.setupMobileInteraction()},100)}),document.addEventListener("keydown",i=>{i.key==="Escape"&&this.isMobile&&this.tocContainer&&(this.tocContainer.classList.add("collapsed"),this.announceToScreenReader("Table of contents collapsed"))});let n=0;document.addEventListener("touchend",i=>{const o=Date.now();o-n<=300&&i.target.closest(".toc-nav a")&&i.preventDefault(),n=o},{passive:!1})}}const m=document.createElement("style");m.textContent=`
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }
`;document.head.appendChild(m);const u=document.getElementById("toc"),h={};if(u){const p=u.getAttribute("data-heading-selector");p&&(h.headingSelector=p);const t=u.getAttribute("data-exclude-selectors");t&&(h.excludeSelectors=t.split(",").map(i=>i.trim()).filter(Boolean));const e=u.getAttribute("data-skip-attr");e&&(h.skipAttribute=e);const n=u.getAttribute("data-skip-class");n&&(h.skipClass=n)}const g=()=>new v(h).init();document.readyState==="loading"?document.addEventListener("DOMContentLoaded",g):g();
